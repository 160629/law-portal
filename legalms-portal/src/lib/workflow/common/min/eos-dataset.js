function Entity(a){if(!a){a="entity"}this.status=Entity.STATUS_INIT;this.name=a;this.values={};this.parent=new Dataset(a);this.keys=[];this.__keys={};this.__type=null;this.id=null}Entity.STATUS_NEW=0;Entity.STATUS_INIT=1;Entity.STATUS_MODIFIED=2;Entity.STATUS_DELT=3;Entity.STATUS_HIDDEN=4;Entity.XPATH_LEVEL=2;Entity.LINK_SIGN="__collection";Entity.prototype.getPropertyByFieldName=function(a){return this.values[a]};Entity.prototype.setPropertyByFieldName=function(a,c){var b=false;b=this.setValue(a,c);if(b){this.update()}};Entity.prototype.setPropertyByXpath=function(e,c){var b=(e+"").split("/");var d=b[b.length-1];if(b.length==1){this.setPropertyByFieldName(d,c);return}b=b.slice(0,b.length-1);e=b.join("/");var a=this.getPropertyByXpath(e);if(a instanceof Entity){a.setPropertyByFieldName(d,c)}else{if(a!==undefined&&a!==null){oldValue=a[d];a[d]=c}else{a=this.createEntityTree(e);a.setPropertyByFieldName(d,c)}}};Entity.prototype.createEntityTree=function(f){var c=(f+"").split("/");var a=this;var d;for(var b=0;b<c.length;b++){var e=c[b];d=a.getPropertyByFieldName(e);if(d===null||d===undefined){d=new Entity(e);a.setPropertyByFieldName(e,d)}a=d}return d};Entity.prototype.getPropertyByXpath=function(e){var c=(e+"").split("/");var b=this;for(var a=0;a<c.length;a++){var d=c[a];if(b instanceof Entity){b=b.getPropertyByFieldName(d)}else{b=b[d]}if(b===null||b===undefined){break}}return b};function deepEntity(a){Entity.prototype.getProperty=Entity.prototype.getPropertyByFieldName;Entity.prototype.setProperty=Entity.prototype.setPropertyByFieldName;if(a){Entity.prototype.getProperty=Entity.prototype.getPropertyByXpath;Entity.prototype.setProperty=Entity.prototype.setPropertyByXpath}}deepEntity(false);Entity.prototype.clone=function(a){var d=new Entity(this.name);d.__type=this.__type;for(var c=0;c<this.keys.length;c++){var b=this.keys[c];var e=this.getProperty(b);if(e instanceof Dataset||e instanceof Entity){d.setProperty(b,e.clone(a))}else{d.setValue(b,e)}}return d};Entity.prototype.toXMLString=function(b){b=b!==false;var c=new StringBuffer();var h="";var f=this.name;if(b){if(this.name&&this.name.indexOf("/")>0){h=this.name.split("/")[0];f=this.name.split("/")[1];c.append("<").append(h).append(">\n")}c.append("<").append(f);if(this.__type){c.append(' __type="').append(this.__type).append('"')}if(this.id){}c.append(">\n")}var m=this.getKeys();var a={};for(var e=0;e<m.length;e++){var d=this.getProperty(m[e]);var l=d instanceof Dataset;var n=d instanceof Entity;if(d===null||d===undefined||d===""){if(m[e].indexOf("/")>0){var g=m[e].split("/");if(!a[g[0]]){a[g[0]]=[]}var j="<"+g[1]+' __isNullOrEmpty="null"/>\n';a[g[0]].push(j)}else{c.append("<").append(m[e]).append(' __isNullOrEmpty="null"/>\n')}}else{if(!l&&!n){if(m[e].indexOf("/")>0){var g=m[e].split("/");if(!a[g[0]]){a[g[0]]=[]}var j="<"+g[1]+">"+xmlConversion(d+"")+"</"+g[1]+">\n";a[g[0]].push(j)}else{c.append("<").append(m[e]).append(">");if(d||d===0){c.append(xmlConversion(d.toString()))}c.append("</").append(m[e]).append(">\n")}}else{c.append(d+"")}}}for(var k in a){if(a.hasOwnProperty(k)){c.append("<").append(k).append(">");c.append(a[k].join(""));c.append("</").append(k).append(">\n")}}if(b){c.append("</").append(f).append(">\n");if(h){c.append("</").append(h).append(">\n")}}return c.toString()};Entity.prototype.toJson=function(e){e=e!==false;var c=Entity2Json(this);if(e){var d=this.name.split("/");if(this.__type){c.__type=this.__type}for(var b=0,a=d.length;b<a;b++){var f={};f[d[b]]=c;c=f}}return c};Entity.prototype.toString=Entity.prototype.toXMLString;Entity.prototype.getKeys=function(){return this.keys};Entity.prototype.xpathParse=function(b){b+="";var c=b.indexOf("/");if(c<0){return b}else{var a=b.split("/");if(a.length!=2){$error(EOS_DATASET_NOT_SUPPORT_XPATH)}return a}};Entity.prototype.setValue=function(a,c){var b=false;if(!this.values[a]){if(!this.__keys[a]){this.keys.push(a);this.__keys[a]=true}b=true}else{if(this.values[a]!=c){b=true}}this.values[a]=c;return b};Entity.prototype.getValue=function(a){return this.values[a]};Entity.prototype.update=function(){if(this.parent){if(this.parent instanceof Dataset){this.parent.onUpdateEntity(this)}this.parent.update()}this.__onUpdate();this.onUpdate()};Entity.prototype.onUpdate=function(){};Entity.prototype.__onUpdate=function(){};function Dataset(a){this.values=[];this.entityType=a}Dataset.prototype.addEntity=function(b,a){this.values.push(b);b.parent=this;if(a!==false){b.status=Entity.STATUS_NEW}this.onAddEntity(b);this.update()};Dataset.prototype.insertEntity=function(b,a,c){if(c!==undefined){this.values.splice(c,0,b)}else{this.values.push(b)}b.parent=this;if(a!==false){b.status=Entity.STATUS_NEW}this.onAddEntity(b);this.update()};Dataset.prototype.addBlankEntity=function(){var a=new Entity(this.entityType);if(this.getLength()!=0){a=this.get(0).clone()}this.values.push(a);a.parent=this;a.status=Entity.STATUS_NEW;this.onAddEntity(a);this.update();return a};Dataset.prototype.removeEntity=function(b,a){if(this.onDeleteEntity(b)){if(a===true){for(var c=0;c<this.values.length;c++){var d=this.values[c];if(d===b){this.values.splice(c,1);break}}}else{b.status=Entity.STATUS_DELT}this.update()}};Dataset.prototype.getAlltEntities=function(){var c=[];for(var b=0;b<this.values.length;b++){var a=this.values[b];c.push(a)}return c};Dataset.prototype.setValue=function(a,b,c){a.setValue(b,c)};Dataset.prototype.getModifiedEntities=function(){var c=[];for(var b=0;b<this.values.length;b++){var a=this.values[b];if(a.status==Entity.STATUS_MODIFIED){c.push(a)}}return c};Dataset.prototype.getInsertEntities=function(){var c=[];for(var b=0;b<this.values.length;b++){var a=this.values[b];if(a.status==Entity.STATUS_NEW){c.push(a)}}return c};Dataset.prototype.getRemovedEntities=function(){var c=[];for(var b=0;b<this.values.length;b++){var a=this.values[b];if(a.status==Entity.STATUS_DELT){c.push(a)}}return c};Dataset.prototype.filter=function(c,d){var e=[];for(var b=0;b<this.values.length;b++){var a=this.values[b];if(a.getProperty(c)==d){e.push(a)}}return e};Dataset.prototype.findEntity=function(d,c){for(var b=0;b<this.values.length;b++){var a=this.values[b];if(a.getProperty(d)==c){return a}}return null};Dataset.prototype.toString=function(){var a=new StringBuffer();for(var c=0;c<this.values.length;c++){var b=this.values[c];a.append(b.toString())}return a.toString()};Dataset.prototype.toJson=function(){return Dataset2Json(this)};Dataset.prototype.clear=function(){this.values=[];this.update()};Dataset.prototype.appendDataset=function(c){for(var b=0;b<c.getLength();b++){var a=c.get(b).clone(true);this.addEntity(a);a.status=Entity.STATUS_INIT}this.update()};Dataset.prototype.init=function(b){if(b.length==1){var e=b[0].getAttribute("__isNullOrEmpty");if(e=="empty"||e=="null"){return}}for(var c=0;c<b.length;c++){var d=b[c];if(!d.tagName){continue}var a=Dataset.initEntity(d);a.id=d.getAttribute(Entity.LINK_SIGN)?d.getAttribute(Entity.LINK_SIGN):null;this.onFillEntity(a);this.addEntity(a);a.status=Entity.STATUS_INIT}};Dataset.initEntity=function(d){if(!d){return null}var a=new Entity(d.tagName);a.__type=d.getAttribute("__type");var f=d.childNodes;var c=[];c.type=null;for(var b=0;b<f.length;b++){var g=f[b];if(g.nodeType==1){if(!g.getAttribute(Entity.LINK_SIGN)){Dataset.initField(a,g)}else{if(c.type==g.tagName){c.push(g)}else{if(c.type!=null){var e=new Dataset(c.type);e.init(c);a.setProperty(c.type,e)}c=[];c.type=g.tagName;c.push(g)}}}}if(c.type!=null){var e=new Dataset(c.type);e.init(c);a.setProperty(c.type,e)}c=[];return a};Dataset.initField=function(b,d){if(d.childNodes.length>1){for(var c=0;c<d.childNodes.length;c++){var e=d.childNodes[c];if(e.nodeType==1){var a=d.tagName+"/"+e.tagName;b.setProperty(a,getNodeValue(e))}}}else{b.setProperty(d.tagName,getNodeValue(d))}};Dataset.prototype.slice=function(c,e){var d=new Dataset(this.entityType);if(!e){e=this.getLength()}if(e>this.getLength()){e=this.getLength()}for(var b=c;b<e;b++){var a=this.get(b).clone();d.addEntity(a)}return d};Dataset.prototype.update=function(){this.onUpdate()};Dataset.prototype.getEntities=function(){return this.values};Dataset.prototype.getLength=function(){return this.getEntities().length};Dataset.prototype.get=function(a){return this.values[a]};Dataset.prototype.onFillEntity=function(a){};Dataset.prototype.onUpdateEntity=function(a){};Dataset.prototype.onAddEntity=function(a){};Dataset.prototype.onDeleteEntity=function(a){return true};Dataset.prototype.onUpdate=function(){};Dataset.prototype.clone=function(a){var d=new Dataset(this.entityType);if(!a){return d}else{for(var c=0;c<this.values.length;c++){var b=this.values[c].clone(a);d.values.push(b)}return d}};Dataset.prototype.getInsertDataset=function(){var b=new Dataset(this.entityType);var c=this.getInsertEntities();for(var a=0;a<c.length;a++){b.addEntity(c[a].clone(true))}return b};Dataset.prototype.getRemovedDataset=function(){var b=new Dataset(this.entityType);var c=this.getRemovedEntities();for(var a=0;a<c.length;a++){b.addEntity(c[a].clone(true))}return b};Dataset.prototype.getModifiedDataset=function(){var b=new Dataset(this.entityType);var c=this.getModifiedEntities();for(var a=0;a<c.length;a++){b.addEntity(c[a].clone(true))}return b};Dataset.prototype.getSubmitXML=function(){var c=this.getInsertEntities();var a=new StringBuffer();if(c.length>0){for(var b=0;b<c.length;b++){c[b].name="insertEntities";a.append(c[b].toString())}}else{a.append('<insertEntities __isNullOrEmpty="null"/>')}c=this.getModifiedEntities();if(c.length>0){for(var b=0;b<c.length;b++){c[b].name="updateEntities";a.append(c[b].toString())}}else{a.append('<updateEntities __isNullOrEmpty="null"/>')}c=this.getRemovedEntities();if(c.length>0){for(var b=0;b<c.length;b++){c[b].name="deleteEntities";a.append(c[b].toString())}}else{a.append('<deleteEntities __isNullOrEmpty="null"/>')}return a.toString()};Dataset.create=function(e,c,d){var g=null;$debug("type of xml"+typeof(e));if(typeof(e)=="string"){g=createXmlDom();g.loadXML(e)}else{if(typeof(e)=="object"){g=e}else{$error("error xml of "+e);return null}}if(c.indexOf("/")!=0){c="/"+c}if(c.indexOf("/root/data")<0){c="/root/data"+c}var a=g.selectNodes(c);if(a){if(!d){var b=c.split("/");d=b[b.length-1]}var f=new Dataset(d);f.init(a);return f}else{$error("no node found by xpath:"+c+"in xml:"+g.xml);return null}};function Dataset2Array(c,a,h){var m=[];if(!c){return m}a=a||"";var k=c.getLength();for(var e=0;e<k;e++){var d=c.get(e);if(h){if(d.status==Entity.STATUS_DELT||d.status==Entity.STATUS_HIDDEN){continue}}var f=Entity2Array(d);var g=e+1;for(var b=0;b<f.length;b++){var l=a+"["+g+"]/"+f[b].key;m.push({key:l,value:f[b].value})}}return m}function Entity2Array(d){var f=[];if(!d){return f}if(d.__type){f.push({key:"__type",value:d.__type})}var g=d.keys.length;for(var e=0;e<g;e++){var k=d.keys[e];var h=d.getProperty(k);if(h instanceof Entity){var a=Entity2Array(h);for(var c=0;c<a.length;c++){var b=k+"/"+a[c].key;f.push({key:b,value:a[c].value})}}else{if(h instanceof Dataset){var l=Dataset2Array(h,k);for(var c=0;c<l.length;c++){k=l[c].key;f.push({key:k,value:l[c].value})}}else{k=k;f.push({key:k,value:h})}}}return f}function isEmptyObject(b){if(typeof(b)!="object"){return false}for(var a in b){return false}return true}function Json2Entity(c,a){if(!c){return c}a=a||new Entity();for(var b in c){if(c.hasOwnProperty(b)){var d=c[b];if(isArray(d)){d=Json2Dataset(d,b)}else{if(isEmptyObject(d)){d=null}else{if(d!==null&&d!==undefined&&typeof(d)=="object"){d=Json2Entity(d);d.parent=a;d.name=b}}}a.setProperty(b,d)}}return a}function Json2Dataset(b,e,f){f=f||new Dataset();b=b||[];if(!isArray(b)){b=[b]}for(var d=0,c=b.length;d<c;d++){var a=Json2Entity(b[d]);a.name=e||a.name;f.addEntity(a,false)}return f}function Entity2Json(a,d){d=d||{};var e=a.getKeys();for(var c=0,b=e.length;c<b;c++){var f=a.getProperty(e[c]);if(f instanceof Entity){f=Entity2Json(f)}else{if(f instanceof Dataset){f=Dataset2Json(f)}}d[e[c]]=f}return d}function Dataset2Json(f,c,a){c=c||[];for(var e=0,d=f.values.length;e<d;e++){var b=f.values[e];if(a!==true&&(b.status==Entity.STATUS_DELT||b.status==Entity.STATUS_HIDDEN)){continue}c.push(Entity2Json(b))}return c};